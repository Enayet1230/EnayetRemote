var vXmlHttp=null;var vIsXmlHttpSending=false;var vSaveCounter=0;var vXmlHttpTimeout=null;var vBackgroundSaveTimeout=null;var vCheckStatusTimeout=null;var vStatusCheckPending=false;var vBackgroundSavePending=false;var vConsecutiveSaveFailures=0;var vLastPostData='';var vIsDomcPost=false;function GetITSXmlHttpObject(a){var b=null;var c=true;if(!window.XMLHttpRequest){b=GetMSXmlHttp();c=false}else{b=new XMLHttpRequest();if(navigator.userAgent.indexOf("MSIE")!=-1)c=false}return{xmlHttp:b,isXmlHttp:c,httpCallback:a}}function GetMSXmlHttp(){var a=null;var b=["Msxml2.XMLHTTP.6.0","Msxml2.XMLHTTP.5.0","Msxml2.XMLHTTP.4.0","Msxml2.XMLHTTP.3.0","Msxml2.XMLHTTP.2.6","Microsoft.XMLHTTP.1.0","Microsoft.XMLHTTP.1","Microsoft.XMLHTTP"];for(var i=0;i<b.length&&a==null;i++){a=CreateXmlHttp(b[i])}return a}function CreateXmlHttp(a){var b=null;try{b=new ActiveXObject(a);lastclsid=a;return b}catch(e){}}function CreatePostFormElement(a,b){return{name:a,value:b}}function AppendAdditionalActions(a,b){if(a==null||a=='')return b;else return a+';'+b}function CreatePostData(){var a=elementFrame();var b=new Array();var c='';var d='';var e=false;var f=false;if(arguments.length>0)d=arguments[0];if(arguments.length>1)e=arguments[1];if(a){var g=a.document.forms[0];var h=0;var i=0;var j='';f=a.vTimingEnabled||(typeof(itd.vCheckSessionStatus)!="undefined"&&itd.vCheckSessionStatus);ITDSetPageComplete();for(i=0;i<g.elements.length;i++){var k=g.elements[i];var l=k.tagName.toLowerCase();var m='';var n=h;if(k.name!=null&&k.name.length!=0){if(l=="input"){var o=k.type.toLowerCase();m=k.value;if(o=="checkbox"||o=="radio"){if(k.checked)b[h++]=CreatePostFormElement(k.name,m);else n=-1}else{j=k.name.toLowerCase();if(j!="pc"){if(j=="actions")m=AppendAdditionalActions(m,d);else if(j=="timespentonobject"&&typeof ITDGetTimeSpentForSave=='function')m=ITDGetTimeSpentForSave();else if(j=="totaltimespentonobject"&&typeof ITDGetTotalTimeSpentForSave=='function')m=ITDGetTotalTimeSpentForSave();b[h++]=CreatePostFormElement(k.name,m)}else n=-1}}else if(l=="select"){if(k.selectedIndex>=0){if(k.options[k.selectedIndex].value.length!=0)m=k.options[k.selectedIndex].value;else m=k.options[k.selectedIndex].text}else m="";if(k.name.toLowerCase()=="actions")m=AppendAdditionalActions(m,d);b[h++]=CreatePostFormElement(k.name,m)}else{m=k.value;b[h++]=CreatePostFormElement(k.name,m)}if(!f&&n>=0){j=b[n].name.toLowerCase();if(j!="timespentonobject"&&j!="totaltimespentonobject"&&j!="savecounter"){if(c.length>0)c+='&';c+=b[n].name+'='+b[n].value}}}}if(!f){if(!e&&c==vLastPostData)b=new Array();else vLastPostData=c}if(b.length>0){ITDSetPageComplete();b[h++]=CreatePostFormElement("PC",g.PC.value)}}return b}function ResetXmlHttpObject(){var a=5;if(typeof vBackgroundSaveFailureThreshold!='undefined')a=vBackgroundSaveFailureThreshold;vConsecutiveSaveFailures++;if(vConsecutiveSaveFailures>=a&&typeof vStopOnBackgroundSaveFailure!='undefined'&&vStopOnBackgroundSaveFailure&&typeof fatalSystemError!='undefined'){fatalSystemError('1006');return false}vStatusCheckPending=false;vBackgroundSavePending=false;vIsXmlHttpSending=false;return true}function PostXmlHttpRequest(a,b,c,d){var f='';for(i=0;i<c.length;i++){if(i>0)f+='&';f+=c[i].name+'='+encodeURIComponent(c[i].value)}if(d){vIsXmlHttpSending=true;vXmlHttpTimeout=window.setTimeout(function(){ResetXmlHttpObject()},50000)}a.xmlHttp.open('POST',b,d);a.xmlHttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");if(d){if(a.isXmlHttp){a.xmlHttp.onload=a.httpCallback;a.xmlHttp.onerror=a.httpCallback}else{a.xmlHttp.onreadystatechange=a.httpCallback}}try{a.xmlHttp.send(f)}catch(e){if(!d)return""}if(!d)return a.xmlHttp.responseText}function PostITSXmlHttpRequest(a,b){var c=false;if(b.length==0)return true;try{if(!vIsXmlHttpSending){c=true;if(vXmlHttp==null)vXmlHttp=GetITSXmlHttpObject(ITSXmlHttpCallbackMethod);PostXmlHttpRequest(vXmlHttp,a,b,true);return true}}catch(e){if(c&&vIsXmlHttpSending)vIsXmlHttpSending=false}return false}function PostITSCheckStatusRequest(a){var b=false;var c=new Array(CreatePostFormElement("checkStatus","true"));if(c.length==0)return true;try{if(!vIsXmlHttpSending){b=true;if(vXmlHttp==null)vXmlHttp=GetITSXmlHttpObject(ITSXmlHttpCheckStatusCallback);PostXmlHttpRequest(vXmlHttp,a,c,true);return true}}catch(e){if(b&&vIsXmlHttpSending)vIsXmlHttpSending=false}return false}function ITSXmlHttpCallbackMethod(){try{if(vXmlHttp.xmlHttp.readyState==4||vXmlHttp.xmlHttp.readyState=='complete'){vConsecutiveSaveFailures=0;window.clearTimeout(vXmlHttpTimeout);vIsXmlHttpSending=false;vStatusCheckPending=false;vBackgroundSavePending=false;var a=elementFrame();if(vIsDomcPost&&typeof(a)!="undefined"&&typeof(a.ITDDomcReturn)=="function"){vIsDomcPost=false;a.ITDDomcReturn(vXmlHttp.xmlHttp.responseText)}else if(typeof(ReceiveITSXmlHttpResponse)=='function')ReceiveITSXmlHttpResponse(vXmlHttp.xmlHttp.responseText)}}catch(e){window.clearTimeout(vXmlHttpTimeout);vIsXmlHttpSending=false;vStatusCheckPending=false;vBackgroundSavePending=false;ResetXmlHttpObject()}}function ITSXmlHttpCheckStatusCallback(){try{if(vXmlHttp.xmlHttp.readyState==4||vXmlHttp.xmlHttp.readyState=='complete'){vConsecutiveSaveFailures=0;window.clearTimeout(vXmlHttpTimeout);vIsXmlHttpSending=false;vStatusCheckPending=false;vBackgroundSavePending=false;if(typeof(itd.vSessionComplete)=="undefined"||!itd.vSessionComplete){if(vXmlHttp.xmlHttp.responseText.match("^1")=="1")itd.navigateTD("refresh");else if(vXmlHttp.xmlHttp.responseText.match("^2")=="2")itd.navigateTD("proctornav")}}}catch(e){window.clearTimeout(vXmlHttpTimeout);vIsXmlHttpSending=false;vStatusCheckPending=false;vBackgroundSavePending=false;ResetXmlHttpObject()}}function ITSIncrementSaveCounter(){var a=elementFrame();if(a){try{vSaveCounter++;var b=a.document.forms[0];b.SaveCounter.value=vSaveCounter}catch(ex){return false}}return true}function ITSStartStatusCheck(){if(!itdLoadComplete||vStatusCheckPending)vCheckStatusTimeout=window.setTimeout(function(){ITSStartStatusCheck()},100);else if(!itd.vIsProctorLed&&itd.vCheckSessionStatus){var a=5000;if(typeof vOverrideCheckStatusInterval!='undefined'&&vOverrideCheckStatusInterval>=1000)a=vOverrideCheckStatusInterval;else if(typeof vCheckStatusInterval!='undefined'&&(vCheckStatusInterval>=1000||vCheckStatusInterval==0))a=vCheckStatusInterval;if(a>0)vCheckStatusTimeout=window.setTimeout(function(){ITSCheckStatus()},a)}}function ITSCheckStatus(){if(vIsXmlHttpSending){vCheckStatusTimeout=window.setTimeout(function(){ITSCheckStatus()},100);return}else if(!awaitingTimeoutAction&&itdLoadComplete&&timerMode!=0){vStatusCheckPending=true;PostITSCheckStatusRequest("itdcheckstatus.aspx?data="+vQueryStringData)}if(itdLoadComplete)ITSStartStatusCheck()}function ITSStopStatusCheck(){if(vCheckStatusTimeout)window.clearTimeout(vCheckStatusTimeout);vCheckStatusTimeout=null;vStatusCheckPending=false}function ITSStartBackgroundSave(){if(!itd.itdLoadComplete||vBackgroundSavePending)vBackgroundSaveTimeout=window.setTimeout(function(){ITSStartBackgroundSave()},100);else{var a=30000;if(typeof vBackgroundSaveInterval!='undefined'&&(vBackgroundSaveInterval>=10000||vBackgroundSaveInterval==0))a=vBackgroundSaveInterval;if(a>0)vBackgroundSaveTimeout=window.setTimeout(function(){ITSBackgroundSave()},a)}}function ITSStopBackgroundSave(){if(vBackgroundSaveTimeout)window.clearTimeout(vBackgroundSaveTimeout);vLastPostData='';vBackgroundSaveTimeout=null;vBackgroundSavePending=false}function ITSForceBackgroundSave(){ITSStopBackgroundSave();vBackgroundSaveTimeout=window.setTimeout(function(){ITSBackgroundSave()},100)}function ITSBackgroundSave(){if(vIsXmlHttpSending){vBackgroundSaveTimeout=window.setTimeout(function(){ITSBackgroundSave()},100);return}else if(!awaitingTimeoutAction&&itdLoadComplete&&timerMode!=0){var a=elementFrame();var b='';if(a){if(typeof a.getSource=="function")a.getSource();if(typeof a.ETSGetSource=="function")a.ETSGetSource();if(typeof itd.itdANSaveChanges=='function')itd.itdANSaveChanges();if(typeof itd.itdSetActionElementString=='function')itd.itdSetActionElementString();ITSIncrementSaveCounter();vBackgroundSavePending=true;if(typeof(itd.vCheckSessionStatus)=="undefined"||!itd.vCheckSessionStatus)PostITSXmlHttpRequest("itd.aspx?cmd=save&data="+vQueryStringData,CreatePostData(b));else PostITSXmlHttpRequest("itd.aspx?cmd=save&ss=1&data="+vQueryStringData,CreatePostData(b))}}if(itdLoadComplete)ITSStartBackgroundSave()}